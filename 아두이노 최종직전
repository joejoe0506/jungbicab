#include <SoftwareSerial.h>

// ğŸ”¹ ë¸”ë£¨íˆ¬ìŠ¤ìš© ì†Œí”„íŠ¸ì›¨ì–´ ì‹œë¦¬ì–¼
SoftwareSerial BTSerial(10, 11); // TX=10, RX=11

// ğŸ”¹ NodeMCU í†µì‹ ìš© (Mega TX1=18 â†’ NodeMCU RX)
#define NodeSerial Serial1

// ğŸ”¹ FSR ì„¼ì„œ í•€
const int fsr1 = A0;
const int fsr2 = A1;
const int fsr3 = A2;

// ğŸ”¹ LED / ë¶€ì € í•€
const int led1 = 52;
const int led2 = 50;
const int led3 = 48;

const int statusLED = 46;   // ì‘ì—…ì¤‘/ì‘ì—…ì™„ë£Œ LED
const int buzzer = 3;

// ğŸ”¹ ìŠ¤ìœ„ì¹˜ í•€ (í† ê¸€ìš©)
const int switchPin = 44;

// ğŸ”¹ ê¸°ì¤€ê°’
const int threshold = 100;

// ğŸ”¹ ìƒíƒœ ë³€ìˆ˜ë“¤
String code = "";
int workState = 0;            // 0 = ì‘ì—…ì¤‘, 1 = ì‘ì—…ì™„ë£Œ
int lastSwitchState = HIGH;   // ë””ë°”ìš´ì‹± ìœ„í•œ ì´ì „ ë²„íŠ¼ ìƒíƒœ ì €ì¥

void setup() {
  Serial.begin(9600);
  BTSerial.begin(9600);
  NodeSerial.begin(9600);

  pinMode(led1, OUTPUT);
  pinMode(led2, OUTPUT);
  pinMode(led3, OUTPUT);
  pinMode(statusLED, OUTPUT);
  pinMode(buzzer, OUTPUT);

  pinMode(switchPin, INPUT_PULLUP);   // ìŠ¤ìœ„ì¹˜ ëˆŒë¦¬ë©´ LOW

  Serial.println("=== FSR + í† ê¸€ ìŠ¤ìœ„ì¹˜ ì—°ê²° ì™„ë£Œ ===");
}

void loop() {

  // ===================================================
  // 1ï¸âƒ£ FSR ì„¼ì„œ ì½ê¸° â†’ 1 or 0 ë³€í™˜
  // ===================================================
  int v1 = analogRead(fsr1);
  int v2 = analogRead(fsr2);
  int v3 = analogRead(fsr3);

  int s1 = (v1 >= threshold) ? 1 : 0;
  int s2 = (v2 >= threshold) ? 1 : 0;
  int s3 = (v3 >= threshold) ? 1 : 0;

  // ===================================================
  // 2ï¸âƒ£ ìŠ¤ìœ„ì¹˜(44ë²ˆ) ëˆŒë¦¼ ê°ì§€í•´ì„œ workState í† ê¸€
  // ===================================================
  int switchState = digitalRead(switchPin);

  if (switchState == LOW && lastSwitchState == HIGH) {
    // ë²„íŠ¼ ëˆŒë ¸ì„ ë•Œë§Œ í† ê¸€!
    workState = !workState;  // 0 â†” 1 ìƒíƒœ ë³€ê²½

    Serial.print("ì‘ì—… ìƒíƒœ ë³€ê²½ â†’ ");
    Serial.println(workState == 1 ? "ì‘ì—…ì™„ë£Œ (1)" : "ì‘ì—…ì¤‘ (0)");

    delay(250); // ë””ë°”ìš´ìŠ¤
  }

  lastSwitchState = switchState;

  // ===================================================
  // 3ï¸âƒ£ LED 46ë²ˆì— ì‘ì—… ìƒíƒœ ë°˜ì˜
  // ===================================================
  digitalWrite(statusLED, workState ? HIGH : LOW);

  // ===================================================
  // 4ï¸âƒ£ 4ìë¦¬ ì½”ë“œ ìƒì„±
  // ===================================================
  code = String(s1) + String(s2) + String(s3) + String(workState);

  Serial.print("ì½”ë“œ ìƒì„±: ");
  Serial.println(code);

  // ===================================================
  // 5ï¸âƒ£ NodeMCU + Bluetooth ë¡œ ì½”ë“œ ì „ì†¡
  // ===================================================
  BTSerial.println(code);
  NodeSerial.println(code);

  // ===================================================
  // 6ï¸âƒ£ ê³µêµ¬ LED ë°˜ì˜
  // ===================================================
  digitalWrite(led1, s1 ? HIGH : LOW);
  digitalWrite(led2, s2 ? HIGH : LOW);
  digitalWrite(led3, s3 ? HIGH : LOW);

  // ===================================================
  // 7ï¸âƒ£ ì‘ì—…ì™„ë£Œ + ê³µêµ¬ ì—†ìŒ â†’ ë¶€ì € ê²½ê³ 
  // ===================================================
  if (workState == 1) {  // ì‘ì—…ì™„ë£Œ
    if (s1 == 0 || s2 == 0 || s3 == 0) {
      tone(buzzer, 1000);
      delay(2000);
      noTone(buzzer);
    }
  } else {
    noTone(buzzer);
  }

  delay(300);
}
