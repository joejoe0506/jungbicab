#include <SoftwareSerial.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>

SoftwareSerial BTSerial(10, 11); // TX=10, RX=11

// LED, 부저 핀
const int led1 = 52;
const int led2 = 50;
const int led3 = 48;
const int buzzer = 3;

// LCD 설정 (주소 0x27, 16x2)
LiquidCrystal_I2C lcd(0x27, 16, 2);

String inputData = "";

void setup() {
  Serial.begin(9600);      // 시리얼 모니터용
  BTSerial.begin(9600);    // 블루투스 모듈용

  pinMode(led1, OUTPUT);
  pinMode(led2, OUTPUT);
  pinMode(led3, OUTPUT);
  pinMode(buzzer, OUTPUT);

  lcd.init();
  lcd.backlight();
  lcd.clear();

  Serial.println("Enter 4-digit code (e.g., 1111, 0100):");
}

void loop() {
  if (Serial.available() > 0) {
    inputData = Serial.readStringUntil('\n');
    inputData.trim(); // 공백 제거

    Serial.print("You entered: ");
    Serial.println(inputData);

    // 블루투스로 전송
    BTSerial.println(inputData);
    Serial.println("Data sent via Bluetooth!");

    if (inputData.length() == 4) {
      // 앞 3자리로 LED 제어
      bool led1State = inputData[0] == '1';
      bool led2State = inputData[1] == '1';
      bool led3State = inputData[2] == '1';

      digitalWrite(led1, led1State ? HIGH : LOW);
      digitalWrite(led2, led2State ? HIGH : LOW);
      digitalWrite(led3, led3State ? HIGH : LOW);

      // 부저 제어 (최종 수정됨)
      if (inputData[3] == '1') { // 마지막 숫자가 1일 때 (작업중)
        noTone(buzzer); // 어떤 경우에도 울리지 않음
      } else if (inputData[3] == '0') { // 마지막 숫자가 0일 때 (작업완료)
        if (!led1State || !led2State || !led3State) { // 하나라도 1이면 부저 울림
          tone(buzzer, 1000);
          delay(2000);
          noTone(buzzer);
        } else {
          noTone(buzzer);
        }
      }
      // LCD 표시
      lcd.clear();
      if (inputData[3] == '0') { // 마지막 숫자 1 → 작업중
        lcd.setCursor(0, 0);
        lcd.print("작업중");
      } else { // 마지막 숫자 0 → 작업완료
        lcd.setCursor(0, 0);
        lcd.print("작업완료");

        // 앞 3자리 중 하나라도 0이면 공구 미반납 표시
        if (led1State || led2State || led3State) {
          lcd.setCursor(0, 1);
          lcd.print("공구 미반납");
        }
      }
    } else {
      Serial.println("⚠️ Please enter exactly 4 digits (e.g., 1111 or 0100).");
    }
  }
}
